# Docker Compose untuk deployment terdistribusi
# Untuk menjalankan di server yang berbeda, gunakan file ini sebagai template

version: "3.8"
services:
    validator1:
        build:
            context: .
            dockerfile: backend/chain/Dockerfile
        image: evote-validator1:latest
        container_name: evote-validator-1
        volumes:
            - ./data/node1/config:/root/.cometbft/config
            - ./data/node1/data:/root/.cometbft/data
            - ./scripts/entrypoint-distributed.sh:/entrypoint.sh:ro
        ports:
            - "26657:26657" # RPC
            - "26656:26656" # P2P
            - "26658:26658" # ABCI
        networks:
            - evote-net
        entrypoint: ["/bin/sh", "/entrypoint.sh"]
        environment:
            - HOME_DIR=/root/.cometbft
            - MONIKER=validator1
            - EXTERNAL_ADDRESS=validator1:26656
        restart: unless-stopped

    validator2:
        build:
            context: .
            dockerfile: backend/chain/Dockerfile
        image: evote-validator2:latest
        container_name: evote-validator-2
        volumes:
            - ./data/node2/config:/root/.cometbft/config
            - ./data/node2/data:/root/.cometbft/data
            - ./scripts/entrypoint-distributed.sh:/entrypoint.sh:ro
        ports:
            - "26667:26657" # RPC
            - "26666:26656" # P2P
            - "26668:26658" # ABCI
        networks:
            - evote-net
        entrypoint: ["/bin/sh", "/entrypoint.sh"]
        environment:
            - HOME_DIR=/root/.cometbft
            - MONIKER=validator2
            - EXTERNAL_ADDRESS=validator2:26656
        restart: unless-stopped

    backend:
        build:
            context: .
            dockerfile: backend/api/Dockerfile
        image: evote-backend:latest
        container_name: evote-backend
        environment:
            - COMET_RPC=http://validator1:26657
        ports:
            - "8080:8080"
        networks:
            - evote-net
        depends_on:
            - validator1
        restart: unless-stopped

    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
        image: evote-frontend:latest
        container_name: evote-frontend
        ports:
            - "3000:3000"
        networks:
            - evote-net
        depends_on:
            - backend
        restart: unless-stopped

    validator3:
        build:
            context: .
            dockerfile: backend/chain/Dockerfile
        image: evote-validator3:latest
        container_name: evote-validator3
        volumes:
            - ./data/validator3/config:/root/.cometbft/config
            - ./data/validator3/data:/root/.cometbft/data
            - ./scripts/entrypoint-distributed.sh:/entrypoint.sh:ro
        ports:
            - "26687:26657"
            - "26686:26656"
            - "26688:26658"
        networks:
            - evote-net
        entrypoint: ["/bin/sh", "/entrypoint.sh"]
        environment:
            - HOME_DIR=/root/.cometbft
            - MONIKER=validator3
            - EXTERNAL_ADDRESS=validator3:26656
        restart: unless-stopped

    validator4:
        build:
            context: .
            dockerfile: backend/chain/Dockerfile
        image: evote-validator4:latest
        container_name: evote-validator4
        volumes:
            - ./data/validator4/config:/root/.cometbft/config
            - ./data/validator4/data:/root/.cometbft/data
            - ./scripts/entrypoint-distributed.sh:/entrypoint.sh:ro
        ports:
            - "26697:26657"
            - "26696:26656"
            - "26698:26658"
        networks:
            - evote-net
        entrypoint: ["/bin/sh", "/entrypoint.sh"]
        environment:
            - HOME_DIR=/root/.cometbft
            - MONIKER=validator4
            - EXTERNAL_ADDRESS=validator4:26656
        restart: unless-stopped

volumes:
    validator1_data:
    validator2_data:

networks:
    evote-net:
        driver: bridge
        ipam:
            config:
                - subnet: 172.20.0.0/16
